---
title: RWA を発行して販売する（regtest）
description: Liquid で RWA アセットを発行し、LN→Liquid Swap（gRPC）で販売する手順。
---

このページは「Liquid で RWA（= Liquid issued asset）を発行し、LN 支払いで販売する」ための runbook です。
このリポジトリの swap 実装は最小構成であり、閉域・信頼ネットワークでの運用を前提にしています。

## 前提（重要）

- 外部 API は gRPC のみです（HTTP JSON は提供しません）。
- gRPC の TLS と認証/認可は実装していません（閉域運用前提）。
- HTLC outputs は explicit（unblinded）です（プライバシー要件がある場合は注意）。
- 現状の `swap_server` / `swap_cli` は `ElementsNetwork::default_regtest()` 固定です。
  - この runbook も Liquid regtest を前提にします。

## 価格の決め方と事前提示（最小）

この swap では **価格は Seller が決めます**。Buyer は次の 2 段で価格を知ります。

1. `CreateQuote` で見積もり（`total_price_msat`）を取得する（quote RPC）
2. `CreateSwap` は `quote_id` を受け取り、見積もり取得後に条件が変化していれば拒否する（過払い防止）

## 役割（Swap server / CLI）

この runbook では、登場人物を次の 2 つに分けます。

- **Swap server**
  - `swap_server`（gRPC サーバ）を運用します。
  - seller/buyer の操作を単一の gRPC server で表現します。
  - seller 側の在庫（RWA + LBTC）を管理し、HTLC funding tx と invoice を作成します。
  - buyer 側の LN 支払いと Liquid claim も実行します（最小構成）。
- **CLI user**
  - `swap_cli`（CLI）で `CreateQuote` / `CreateSwap` / `PayLightning` / `ClaimAsset` を呼び出します。

## 全体像

- **Liquid 側**
  - `elementsd`（liquidregtest）
  - Liquid 対応 `electrs`（Electrum RPC）
  - Seller/Buyer のウォレットは LWK（`lwk_wollet`）
- **Lightning 側**
  - `ldk-server`（seller: invoice 発行、buyer: 支払い）
- **Swap**
  - gRPC server: `swap_server`
  - CLI: `swap_cli`

## Seller: 何を用意すればよいか（チェックリスト）

- LN（seller 側）:
  - `ldk-server` の REST が到達可能であること（`--seller-ldk-rest-addr`）
  - invoice を発行できること
- Liquid:
  - Electrum が到達可能であること（`--liquid-electrum-url`）
  - LWK ウォレットの永続ディレクトリ（`--seller-wallet-dir`）
  - swap 永続 DB（SQLite, `--store-path`）
- 販売条件:
  - `--sell-asset-id`: RWA の `asset_id`
  - `--price-msat-per-asset-unit`: 価格（msat / asset unit）
  - `--fee-subsidy-sats`: claim/refund 用の LBTC 補助（sats）
- 在庫:
  - RWA アセット在庫（`--sell-asset-id`）
  - `fee_subsidy_sats × 想定 swap 数` 以上の LBTC

## Buyer: 何を用意すればよいか（チェックリスト）

- LN（buyer 側）:
  - `ldk-server` の REST が到達可能であること（`--buyer-ldk-rest-addr`）
  - seller へ支払える outbound liquidity があること
- Liquid:
  - Electrum が到達可能であること（`--liquid-electrum-url`）
  - LWK ウォレットの永続ディレクトリ（`--buyer-wallet-dir`）
- 購入条件:
  - `--asset-id`: RWA の `asset_id`（seller の `--sell-asset-id` と一致）
  - `--asset-amount`: 購入量
  - `--min-funding-confs`: funding 確認数（seller の応答に含まれる値を満たすまで待つ）

## 共通: LWK ウォレットの前提（Seller / Buyer）

この実装は LWK（`lwk_wollet`）でウォレットを作ります。
Seller/Buyer はそれぞれ次を用意してください。

- `*_MNEMONIC`: BIP39 mnemonic（例: 12 words）
- `*_SLIP77`: 32 bytes の hex（64文字）
  - 例: `openssl rand -hex 32`
- `--seller-wallet-dir` / `--buyer-wallet-dir`: LWK の永続ディレクトリ（再起動後の復旧に必要）
- `--liquid-electrum-url`: Electrum エンドポイント（例: `tcp://127.0.0.1:50001`）

注意:

- この swap は HTLC outputs を explicit（unblinded）で作ります。
  - そのため Buyer/Seller の受領 output も explicit です（秘密額・秘密アセットではありません）。
- `*_SLIP77` はこの swap の blinding には使っていませんが、ウォレット生成のために引数として必要です。

## 手順 A: まず動作確認（RWA 発行〜販売まで 1 コマンド）

最短で「RWA を発行し、販売し、buyer が claim できる」ことを確認したい場合は、E2E テストを使います。

```sh
nix develop -c just swap_e2e
```

`swap_e2e` は内部で次を実行します。

- Liquid regtest（`elementsd` + Liquid 対応 `electrs`）を起動
- LWK で asset を発行（RWA として扱う）し、seller に在庫として送付
- LN regtest（`bitcoind` + 2つの `ldk-server`）を起動し、チャネルを作成
- seller gRPC を起動し、`CreateSwap` → LN 支払い → Liquid claim まで検証

失敗時に作業ディレクトリを保持してログを確認したい場合は、次も有効です。

```sh
KEEP_LWK_E2E_ARTIFACTS=1 KEEP_LDK_E2E_ARTIFACTS=1 nix develop -c just swap_e2e
```

## 手順 B: swap_server を起動して販売する（サービス開始手順）

ここからは `swap_server` を長時間起動し、gRPC API で販売する手順です。
LN / Liquid の各コンポーネントはすでに起動済みであることを前提にします。

### Seller 1) RWA を発行する（asset_id を得る）

RWA は Liquid の issued asset として表現します。
発行方法（例: Elements RPC / LWK / 既存の社内ツール）は問いません。

- 発行した **asset_id（32 bytes / hex 64文字）** を控えます。
- seller に配る在庫量（`asset_amount`）を決めます。

補足:

- この repo は RWA 発行用の CLI を提供しません。
- regtest で「発行まで含めた最短確認」は `just swap_e2e` を使ってください。

### Seller 2) Seller の在庫を用意する（asset + LBTC）

`swap_server` は LWK ウォレット（`--seller-mnemonic` / `--seller-slip77`）から HTLC を fund します。
そのため、事前に seller ウォレットへ次を入れてください。

- 販売する RWA アセット（`asset_id`）
- 手数料補助用の LBTC（`fee_subsidy_sats` × 想定 swap 数 + 余裕）

在庫を送る先（seller 受領アドレス）は、`swap_server` 起動時にログへ出力されます。
（`seller_receive_address=...`）

メモ:

- `swap_server` を起動したまま在庫を入れても構いません（次回の `CreateSwap` から利用されます）。
- 在庫が不足している場合、`CreateSwap` は `FAILED_PRECONDITION` で失敗します。

### Server 3) swap_server を起動する

例（gRPC は plaintext、SQLite 永続化あり）:

```sh
nix develop -c cargo run --bin swap_server -- \
  --listen-addr 127.0.0.1:50051 \
  --seller-ldk-rest-addr http://127.0.0.1:3001 \
  --buyer-ldk-rest-addr http://127.0.0.1:3002 \
  --liquid-electrum-url tcp://127.0.0.1:50001 \
  --seller-wallet-dir ./data/seller_wallet \
  --buyer-wallet-dir ./data/buyer_wallet \
  --store-path ./data/store.sqlite3 \
  --seller-mnemonic "$SELLER_MNEMONIC" \
  --seller-slip77 "$SELLER_SLIP77" \
  --buyer-mnemonic "$BUYER_MNEMONIC" \
  --buyer-slip77 "$BUYER_SLIP77" \
  --sell-asset-id "$RWA_ASSET_ID" \
  --price-msat-per-asset-unit 1000 \
  --fee-subsidy-sats 10000 \
  --refund-delta-blocks 144 \
  --invoice-expiry-secs 3600
```

メモ:

- `--seller-wallet-dir` / `--buyer-wallet-dir` と `--store-path` は **永続領域**に置きます（再起動後の復旧に必要です）。
- `--sell-asset-id` は、手順 1) で発行した RWA の `asset_id` です。
- `--listen-addr` は閉域内でのみ公開してください（TLS/認証なしのため）。

### CLI 1) 購入する（swap_cli）

`swap_cli` は gRPC を呼び出すだけの CLI です。
buyer/seller のウォレットと LN ノードは `swap_server` 側に設定します。

例:

```sh
nix develop -c cargo run --bin swap_cli -- \
  --grpc-url http://127.0.0.1:50051 \
  create-quote \
  --asset-id "$RWA_ASSET_ID" \
  --asset-amount 1000 \
  --min-funding-confs 1

nix develop -c cargo run --bin swap_cli -- \
  --grpc-url http://127.0.0.1:50051 \
  create-swap \
  --quote-id "<QUOTE_ID>"

nix develop -c cargo run --bin swap_cli -- \
  --grpc-url http://127.0.0.1:50051 \
  pay-lightning \
  --swap-id "<SWAP_ID>"

nix develop -c cargo run --bin swap_cli -- \
  --grpc-url http://127.0.0.1:50051 \
  claim-asset \
  --swap-id "<SWAP_ID>"
```

## 運用ノート

- `CreateSwap` は `min_funding_confs` を満たすまでブロックします（長時間 RPC になり得ます）。
- refund は `swap_server` プロセス内の worker が定期実行します（best-effort）。
- ログは `RUST_LOG=info` などで調整できます。
- 価格を変更したい場合は `swap_server` の `--price-msat-per-asset-unit` を変更して再起動します。
  - Buyer は毎回 `CreateQuote` からやり直してください。
